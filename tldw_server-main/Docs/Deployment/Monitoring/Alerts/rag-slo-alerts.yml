apiVersion: 1
groups:
  - orgId: 1
    name: tldw-rag-slos
    folder: TLDW
    interval: 1m
    rules:
      # p95 latency SLO for RAG endpoints
      - uid: tldw_rag_p95_latency
        title: RAG p95 latency high
        condition: C
        for: 10m
        annotations:
          summary: 'RAG p95 latency over SLO threshold'
          description: 'p95(http_request_duration_seconds{endpoint=~"/api/v1/rag.*"}) > 2.0s'
        labels:
          severity: warning
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: histogram_quantile(0.95, sum by (le,endpoint) (rate(http_request_duration_seconds_bucket{endpoint=~"/api/v1/rag.*"}[5m])))
              instant: false
              range: true
          - refId: B
            datasourceUid: __expr__
            model:
              type: math
              expression: A
          - refId: C
            datasourceUid: __expr__
            model:
              type: threshold
              params:
                - 2

      # Faithfulness SLO: supported/(supported+refuted+nei) >= X
      - uid: tldw_rag_faithfulness_low
        title: RAG faithfulness ratio low
        condition: D
        for: 15m
        annotations:
          summary: 'RAG faithfulness below threshold'
          description: '1 - (unsupported/total) < 0.85 over 15m'
        labels:
          severity: warning
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(rag_unsupported_claims_total[15m]))
              instant: false
              range: true
          - refId: B
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: sum(rate(rag_total_claims_checked_total[15m]))
              instant: false
              range: true
          - refId: C
            datasourceUid: __expr__
            model:
              type: math
              expression: 1 - (A / clamp_min(B, 1))
          - refId: D
            datasourceUid: __expr__
            model:
              type: threshold
              params:
                - 0.85

      # Burn rate: combine error budget ratio with short window
      - uid: tldw_rag_burn_rate
        title: RAG burn rate high
        condition: E
        for: 15m
        annotations:
          summary: 'RAG burn rate high for endpoints'
          description: 'p95 latency and faithfulness SLOs breaching while traffic present'
        labels:
          severity: critical
        data:
          - refId: A
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: histogram_quantile(0.95, sum by (le,endpoint) (rate(http_request_duration_seconds_bucket{endpoint=~"/api/v1/rag.*"}[5m])))
              instant: false
              range: true
          - refId: B
            datasourceUid: __expr__
            model:
              type: math
              expression: A - 2
          - refId: C
            datasourceUid: prometheus
            model:
              editorMode: code
              expr: (1 - (sum(rate(rag_unsupported_claims_total[5m])) / clamp_min(sum(rate(rag_total_claims_checked_total[5m])), 1)))
              instant: false
              range: true
          - refId: D
            datasourceUid: __expr__
            model:
              type: math
              expression: 0.85 - C
          - refId: E
            datasourceUid: __expr__
            model:
              type: math
              expression: (B > 0) * (D > 0)
