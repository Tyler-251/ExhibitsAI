# Dockerfile.ubuntu - Mimics GitHub Actions ubuntu-latest environment
FROM ubuntu:22.04

ARG PYTHON_VERSION=3.12

# Prevent interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    software-properties-common \
    curl \
    git \
    build-essential \
    portaudio19-dev \
    python3-all-dev \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Add deadsnakes PPA for multiple Python versions
RUN add-apt-repository ppa:deadsnakes/ppa && apt-get update

# Install specific Python version
RUN if [ "$PYTHON_VERSION" = "3.10" ]; then \
        apt-get install -y python3.10 python3.10-dev python3.10-venv python3.10-distutils; \
    elif [ "$PYTHON_VERSION" = "3.11" ]; then \
        apt-get install -y python3.11 python3.11-dev python3.11-venv python3.11-distutils; \
    elif [ "$PYTHON_VERSION" = "3.12" ]; then \
        apt-get install -y python3.12 python3.12-dev python3.12-venv python3.12-distutils; \
    elif [ "$PYTHON_VERSION" = "3.13" ]; then \
        apt-get install -y python3.13 python3.13-dev python3.13-venv; \
    fi && \
    rm -rf /var/lib/apt/lists/*

# Install pip for the specific Python version
RUN curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py && \
    python$PYTHON_VERSION get-pip.py && \
    rm get-pip.py

# Set working directory
WORKDIR /app

# Create a script to run the workflow tests
RUN echo '#!/bin/bash\n\
set -e\n\
echo "Testing GitHub Actions workflow with Python $PYTHON_VERSION"\n\
python$PYTHON_VERSION -m pip install --upgrade pip\n\
pip install -e ".[dev]"\n\
echo "Running tests..."\n\
cd tldw_Server_API\n\
pytest --markers\n\
pytest -v -m "unit" --collect-only | head -20\n\
black --version\n\
ruff --version\n\
mypy --version\n\
' > /test-runner.sh && chmod +x /test-runner.sh

CMD ["/test-runner.sh"]
