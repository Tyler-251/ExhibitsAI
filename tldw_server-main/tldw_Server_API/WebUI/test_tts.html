<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .provider-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .provider-card h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        audio {
            width: 100%;
            margin-top: 10px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üéôÔ∏è TTS System Test Interface</h1>

    <div class="test-section">
        <h2>Test Configuration</h2>
        <div>
            <label>API Base URL:</label>
            <input type="text" id="api-url" value="http://localhost:8000/api/v1" style="width: 300px;">
            <label style="margin-left: 20px;">API Key (if required):</label>
            <input type="password" id="api-key" placeholder="Optional" style="width: 200px;">
        </div>
    </div>

    <div class="test-section">
        <h2>Provider Status Check</h2>
        <button onclick="checkHealth()">Check All Providers</button>
        <div id="health-status" class="status info" style="display:none;"></div>
    </div>

    <div class="test-section">
        <h2>Text Input</h2>
        <textarea id="test-text" rows="4">
This is a test of the TTS system. Each provider has unique capabilities and voice characteristics that we can explore.
        </textarea>
    </div>

    <div class="test-section">
        <h2>Test Each Provider</h2>
        <div class="provider-grid">
            <!-- VibeVoice -->
            <div class="provider-card">
                <h3>üåä VibeVoice</h3>
                <p>Features: Voice cloning, multi-speaker, long-form</p>
                <select id="vibevoice-voice">
                    <option value="aurora">Aurora</option>
                    <option value="phoenix">Phoenix</option>
                    <option value="sage">Sage</option>
                    <option value="nova">Nova</option>
                </select>
                <button onclick="testProvider('vibevoice')">Test VibeVoice</button>
                <div id="vibevoice-status"></div>
                <audio id="vibevoice-audio" controls style="display:none;"></audio>
            </div>

            <!-- NeuTTS Air -->
            <div class="provider-card">
                <h3>‚òÅÔ∏è NeuTTS Air</h3>
                <p>Features: Instant voice cloning (ref audio + text). Streaming with GGUF.</p>
                <label for="neutts-model">Model:</label>
                <select id="neutts-model">
                    <option value="neutts-air">neutts-air (HF, non-streaming)</option>
                    <option value="neutts-air-q8-gguf">neutts-air-q8-gguf (GGUF, streaming)</option>
                    <option value="neutts-air-q4-gguf">neutts-air-q4-gguf (GGUF, streaming)</option>
                </select>
                <div style="margin-top:8px">
                    <label for="neutts-format">Format:</label>
                    <select id="neutts-format">
                        <option value="wav">wav</option>
                        <option value="mp3" selected>mp3</option>
                        <option value="opus">opus</option>
                        <option value="flac">flac</option>
                        <option value="pcm">pcm</option>
                    </select>
                </div>
                <div style="margin-top:8px">
                    <label for="neutts-stream"><input type="checkbox" id="neutts-stream"> Stream (GGUF only)</label>
                </div>
                <div style="margin-top:8px">
                    <label>Reference Audio (3-15s):</label>
                    <input type="file" id="neutts-ref-audio" accept="audio/*">
                </div>
                <div style="margin-top:8px">
                    <label>Or Quick Record:</label>
                    <div>
                        <button onclick="startNeuTTSRecording()" id="neutts-rec-start">Record</button>
                        <button onclick="stopNeuTTSRecording()" id="neutts-rec-stop" disabled>Stop</button>
                        <span id="neutts-rec-status" class="status info" title="If a recording is present, it overrides the selected file.">Idle (recording overrides file)</span>
                    </div>
                    <audio id="neutts-rec-playback" controls style="display:none; width:100%; margin-top:6px;"></audio>
                </div>
                <div style="margin-top:8px">
                    <label>Reference Text:</label>
                    <input type="text" id="neutts-ref-text" placeholder="Text spoken in the reference clip" style="width:100%">
                </div>
                <div style="margin-top:8px">
                    <button onclick="testProvider('neutts')">Test NeuTTS</button>
                </div>
                <div id="neutts-status"></div>
                <audio id="neutts-audio" controls style="display:none;"></audio>
            </div>

            <!-- Kokoro -->
            <div class="provider-card">
                <h3>‚ù§Ô∏è Kokoro</h3>
                <p>Features: Lightweight, voice mixing, fast</p>
                <select id="kokoro-voice">
                    <option value="af_bella">Bella (US Female)</option>
                    <option value="am_adam">Adam (US Male)</option>
                    <option value="bf_emma">Emma (UK Female)</option>
                    <option value="bm_george">George (UK Male)</option>
                </select>
                <button onclick="testProvider('kokoro')">Test Kokoro</button>
                <div id="kokoro-status"></div>
                <audio id="kokoro-audio" controls style="display:none;"></audio>
            </div>

            <!-- Higgs -->
            <div class="provider-card">
                <h3>‚öõÔ∏è Higgs</h3>
                <p>Features: 50+ languages, voice cloning, music</p>
                <select id="higgs-voice">
                    <option value="narrator">Narrator</option>
                    <option value="conversational">Conversational</option>
                    <option value="expressive">Expressive</option>
                    <option value="melodic">Melodic</option>
                </select>
                <button onclick="testProvider('higgs')">Test Higgs</button>
                <div id="higgs-status"></div>
                <audio id="higgs-audio" controls style="display:none;"></audio>
            </div>

            <!-- Chatterbox -->
            <div class="provider-card">
                <h3>üí¨ Chatterbox</h3>
                <p>Features: Emotion control, voice cloning</p>
                <select id="chatterbox-voice">
                    <option value="default">Default</option>
                    <option value="energetic">Energetic</option>
                    <option value="calm">Calm</option>
                    <option value="professional">Professional</option>
                </select>
                <button onclick="testProvider('chatterbox')">Test Chatterbox</button>
                <div id="chatterbox-status"></div>
                <audio id="chatterbox-audio" controls style="display:none;"></audio>
            </div>

            <!-- OpenAI -->
            <div class="provider-card">
                <h3>üß† OpenAI</h3>
                <p>Features: High quality, consistent</p>
                <select id="openai-voice">
                    <option value="alloy">Alloy</option>
                    <option value="echo">Echo</option>
                    <option value="fable">Fable</option>
                    <option value="onyx">Onyx</option>
                    <option value="nova">Nova</option>
                    <option value="shimmer">Shimmer</option>
                </select>
                <button onclick="testProvider('openai')">Test OpenAI</button>
                <div id="openai-status"></div>
                <audio id="openai-audio" controls style="display:none;"></audio>
            </div>

            <!-- ElevenLabs -->
            <div class="provider-card">
                <h3>üéôÔ∏è ElevenLabs</h3>
                <p>Features: Ultra-realistic, voice cloning</p>
                <select id="elevenlabs-voice">
                    <option value="rachel">Rachel</option>
                    <option value="domi">Domi</option>
                    <option value="bella">Bella</option>
                    <option value="antoni">Antoni</option>
                </select>
                <button onclick="testProvider('elevenlabs')">Test ElevenLabs</button>
                <div id="elevenlabs-status"></div>
                <audio id="elevenlabs-audio" controls style="display:none;"></audio>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Batch Test</h2>
        <button onclick="testAllProviders()">Test All Available Providers</button>
        <div id="batch-status"></div>
    </div>

    <!-- Inline handler shim removed after migrating handlers to modules -->
    <script>
        const API_BASE = () => document.getElementById('api-url').value;
        const API_KEY = () => document.getElementById('api-key').value;

        async function checkHealth() {
            const statusDiv = document.getElementById('health-status');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status info';
            statusDiv.innerHTML = 'Checking provider health...';

            try {
                const response = await fetch(`${API_BASE()}/audio/health`, {
                    headers: API_KEY() ? { 'Authorization': `Bearer ${API_KEY()}` } : {}
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.status === 'healthy') {
                    statusDiv.className = 'status success';
                    let html = '<strong>System Status: Healthy</strong><br>';

                    if (data.providers) {
                        html += `<br>Total Providers: ${data.providers.total}<br>`;
                        html += `Available: ${data.providers.available}<br><br>`;

                        if (data.providers.details) {
                            html += '<strong>Provider Details:</strong><br>';
                            for (const [provider, info] of Object.entries(data.providers.details)) {
                                const status = info.status || 'unknown';
                                const emoji = status === 'available' ? '‚úÖ' : '‚ùå';
                                html += `${emoji} ${provider}: ${status}<br>`;
                            }
                        }
                    }

                    statusDiv.innerHTML = html;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `System Status: ${data.status}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `Error checking health: ${error.message}`;
            }
        }

        async function testProvider(provider) {
            const text = document.getElementById('test-text').value;
            // Most providers use a voice select; NeuTTS uses special fields
            const voiceSel = document.getElementById(`${provider}-voice`);
            const voice = voiceSel ? voiceSel.value : 'default';
            const statusDiv = document.getElementById(`${provider}-status`);
            const audioEl = document.getElementById(`${provider}-audio`);

            statusDiv.className = 'status info';
            statusDiv.innerHTML = 'Generating speech...';

            try {
                // Build request based on provider
                let request = {
                    input: text,
                    voice: voice,
                    response_format: 'mp3',
                    stream: false
                };

                // Add provider-specific model
                switch(provider) {
                    case 'vibevoice':
                        request.model = 'vibevoice:1.5B';
                        break;
                    case 'kokoro':
                        request.model = 'kokoro';
                        break;
                    case 'higgs':
                        request.model = 'higgs';
                        break;
                    case 'chatterbox':
                        request.model = 'chatterbox';
                        break;
                    case 'openai':
                        request.model = 'tts-1';
                        break;
                    case 'elevenlabs':
                        request.model = 'elevenlabs';
                        break;
                    case 'neutts': {
                        const modelSel = document.getElementById('neutts-model');
                        const fmtSel = document.getElementById('neutts-format');
                        const streamChk = document.getElementById('neutts-stream');
                        const fileInput = document.getElementById('neutts-ref-audio');
                        const refText = document.getElementById('neutts-ref-text').value.trim();
                        const recBlob = window._neuttsRecBlob || null;
                        if (!fileInput.files[0] && !recBlob) {
                            throw new Error('Please record or select a reference audio file for NeuTTS');
                        }
                        if (!refText) {
                            throw new Error('Please enter reference text matching the audio');
                        }
                        // Prefer recorded blob; convert to WAV, then base64
                        const blob = recBlob || fileInput.files[0];
                        const wavBlob = await ensureWav(blob);
                        const b64 = await blobToBase64(wavBlob);
                        request.model = modelSel.value;
                        request.response_format = fmtSel.value;
                        request.stream = !!streamChk.checked;
                        request.voice_reference = b64;
                        request.extra_params = { reference_text: refText };
                        break;
                    }
                }
                // Special-case: when provider is 'neutts', we may have updated format/stream
                const response = await fetch(`${API_BASE()}/audio/speech`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(API_KEY() ? { 'Authorization': `Bearer ${API_KEY()}` } : {})
                    },
                    body: JSON.stringify(request)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || `HTTP ${response.status}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                audioEl.src = url;
                audioEl.style.display = 'block';
                audioEl.play();

                statusDiv.className = 'status success';
                statusDiv.innerHTML = `‚úÖ Success! Audio generated (${(blob.size / 1024).toFixed(2)} KB)`;

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
                audioEl.style.display = 'none';
            }
        }

        async function testAllProviders() {
            const providers = ['vibevoice', 'kokoro', 'higgs', 'chatterbox', 'openai', 'elevenlabs'];
            const batchStatus = document.getElementById('batch-status');

            batchStatus.className = 'status info';
            batchStatus.innerHTML = 'Testing all providers...';

            let results = [];

            for (const provider of providers) {
                try {
                    await testProvider(provider);
                    results.push(`‚úÖ ${provider}`);
                } catch (error) {
                    results.push(`‚ùå ${provider}`);
                }

                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            batchStatus.className = 'status success';
            batchStatus.innerHTML = '<strong>Batch Test Complete:</strong><br>' + results.join('<br>');
        }

        // ---- Simple recorder + helpers for NeuTTS ----
        let _rec = { mr: null, chunks: [], stream: null };
        window._neuttsRecBlob = null;
        async function startNeuTTSRecording() {
            try {
                if (_rec.mr) return;
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mr = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                _rec.stream = stream;
                _rec.chunks = [];
                _rec.mr = mr;
                document.getElementById('neutts-rec-status').textContent = 'Recording...';
                document.getElementById('neutts-rec-start').disabled = true;
                document.getElementById('neutts-rec-stop').disabled = false;
                mr.ondataavailable = (e)=>{ if (e.data && e.data.size) _rec.chunks.push(e.data); };
                mr.onstop = () => {
                    const blob = new Blob(_rec.chunks, { type: 'audio/webm' });
                    window._neuttsRecBlob = blob;
                    const url = URL.createObjectURL(blob);
                    const audio = document.getElementById('neutts-rec-playback');
                    audio.src = url; audio.style.display='block';
                    document.getElementById('neutts-rec-status').textContent = 'Recorded';
                    document.getElementById('neutts-rec-start').disabled = false;
                    document.getElementById('neutts-rec-stop').disabled = true;
                    stream.getTracks().forEach(t=>t.stop());
                    _rec.mr = null; _rec.stream = null;
                };
                mr.start();
            } catch(e) {
                console.error('rec start failed', e);
                document.getElementById('neutts-rec-status').textContent = 'Recording failed';
            }
        }
        function stopNeuTTSRecording() {
            try { if (_rec.mr) _rec.mr.stop(); } catch(e) { console.error(e); }
        }
        async function blobToBase64(blob) {
            const buf = await blob.arrayBuffer();
            let binary=''; const bytes=new Uint8Array(buf); const step=0x8000;
            for(let i=0;i<bytes.length;i+=step){ binary+=String.fromCharCode.apply(null, bytes.subarray(i,i+step)); }
            return btoa(binary);
        }
        async function ensureWav(blob) {
            if (blob.type && (blob.type.includes('wav'))) return blob;
            const buf = await blob.arrayBuffer();
            const ac = new (window.AudioContext||window.webkitAudioContext)();
            const audioBuffer = await ac.decodeAudioData(buf);
            const wavView = encodeWav(audioBuffer);
            return new Blob([wavView], { type: 'audio/wav' });
        }
        function encodeWav(audioBuffer) {
            const ch = audioBuffer.numberOfChannels>1?mixToMono(audioBuffer):audioBuffer.getChannelData(0);
            const pcm = floatTo16(ch);
            const sr = audioBuffer.sampleRate;
            const ab = new ArrayBuffer(44 + pcm.length*2); const view = new DataView(ab);
            writeStr(view,0,'RIFF'); view.setUint32(4,36+pcm.length*2,true); writeStr(view,8,'WAVE');
            writeStr(view,12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true);
            view.setUint16(22,1,true); view.setUint32(24,sr,true); view.setUint32(28,sr*2,true);
            view.setUint16(32,2,true); view.setUint16(34,16,true); writeStr(view,36,'data'); view.setUint32(40,pcm.length*2,true);
            let off=44; for(let i=0;i<pcm.length;i++,off+=2){ view.setInt16(off, pcm[i], true); }
            return view;
        }
        function floatTo16(input){ const out=new Int16Array(input.length); for(let i=0;i<input.length;i++){ let s=Math.max(-1,Math.min(1,input[i])); out[i]=s<0?s*0x8000:s*0x7FFF;} return out; }
        function mixToMono(buf){ const l=buf.length; const a=buf.getChannelData(0), b=buf.getChannelData(1), o=new Float32Array(l); for(let i=0;i<l;i++) o[i]=0.5*(a[i]+b[i]); return o; }
        function writeStr(view, offset, str){ for (let i=0;i<str.length;i++) view.setUint8(offset+i, str.charCodeAt(i)); }

        // Check health on load
        window.addEventListener('load', () => {
            setTimeout(checkHealth, 500);
        });
    </script>
</body>
</html>
