name: E2E Smoke Workflows

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 6 * * 1'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  e2e-smoke:
    name: E2E Smoke - ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            python-version: "3.11"
          - os: ubuntu-latest
            python-version: "3.12"
          - os: ubuntu-latest
            python-version: "3.13"
          - os: windows-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.12"
    env:
      # Ensure Python can import the top-level package `tldw_Server_API` and scripts
      # by including the repository root on sys.path.
      PYTHONPATH: .
      TEST_MODE: "true"
      DISABLE_HEAVY_STARTUP: "1"
      E2E_TEST_BASE_URL: "http://127.0.0.1:8000"
      MCP_JWT_SECRET: test_secret_key_for_ci_only_32_chars_minimum
      MCP_API_KEY_SALT: test_salt_key_for_ci_only_32_chars_minimum
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Setup Python and deps (with uv)
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: ${{ matrix.python-version }}
          use-uv: 'true'
          cache-dependency-path: |
            pyproject.toml
            uv.lock
          # Install via pyproject extras (composite action default: extras='dev')

      - name: Install FFmpeg (+PortAudio)
        uses: ./.github/actions/setup-ffmpeg
        with:
          install-portaudio: 'true'

      - name: Install additional test deps
        run: |
          python -m pip install pytest pytest-asyncio websockets pytest-timeout pytest-xdist
        shell: bash

      - name: Install Playwright browsers
        shell: bash
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            python -m playwright install --with-deps chromium
          else
            python -m playwright install chromium
          fi

      - name: Start server (single-user)
        env:
          SERVER_LABEL: single
          AUTH_MODE: single_user
          SINGLE_USER_API_KEY: "test-api-key-12345"
        shell: bash
        run: |
          python tldw_Server_API/tests/scripts/server_lifecycle.py start

      - name: Wait for API health (single-user, Windows 8 min)
        if: ${{ matrix.os == 'windows-latest' }}
        env:
          SERVER_LABEL: single
          SMOKE_STARTUP_TIMEOUT_SECONDS: '480'
        shell: bash
        run: |
          python tldw_Server_API/tests/scripts/server_lifecycle.py health-check

      - name: Wait for API health (single-user)
        if: ${{ matrix.os != 'windows-latest' }}
        env:
          SERVER_LABEL: single
        shell: bash
        run: |
          python tldw_Server_API/tests/scripts/server_lifecycle.py health-check

      - name: Run E2E tests (single-user) - exclude Jobs
        env:
          AUTH_MODE: single_user
          SINGLE_USER_API_KEY: "test-api-key-12345"
        shell: bash
        run: |
          pytest -v -n 1 -m "critical and not multi_user and not jobs" --timeout=600 \
            tldw_Server_API/tests/e2e/test_tts_stream_http.py \
            tldw_Server_API/tests/e2e/test_prompt_studio_e2e.py \
            tldw_Server_API/tests/e2e/test_rag_deep_checks.py \
            tldw_Server_API/tests/e2e/test_mcp_basic.py \
            tldw_Server_API/tests/e2e/test_rate_limits.py

      - name: Stop server (single-user)
        if: always()
        env:
          SERVER_LABEL: single
        shell: bash
        run: |
          if [ -f "tldw_Server_API/tests/scripts/server_lifecycle.py" ]; then
            python tldw_Server_API/tests/scripts/server_lifecycle.py stop || true
          else
            echo "server_lifecycle.py not found; skipping stop for '${SERVER_LABEL}'";
          fi

      - name: Print server log (single-user)
        if: failure()
        env:
          SERVER_LABEL: single
        shell: bash
        run: |
          python - <<'PY'
          import pathlib, os
          label = os.environ.get("SERVER_LABEL", "server")
          log_path = pathlib.Path(f"server-{label}.log")
          if log_path.exists():
              print("===== server log (single-user) =====")
              print(log_path.read_text(encoding="utf-8"))
          PY
      - name: Upload server log (single-user)
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: server-log-single
          path: server-single.log

      - name: Start server (multi-user)
        env:
          SERVER_LABEL: multi
          AUTH_MODE: multi_user
        shell: bash
        run: |
          python tldw_Server_API/tests/scripts/server_lifecycle.py start

      - name: Wait for API health (multi-user, Windows 8 min)
        if: ${{ matrix.os == 'windows-latest' }}
        env:
          SERVER_LABEL: multi
          SMOKE_STARTUP_TIMEOUT_SECONDS: '480'
        shell: bash
        run: |
          python tldw_Server_API/tests/scripts/server_lifecycle.py health-check

      - name: Wait for API health (multi-user)
        if: ${{ matrix.os != 'windows-latest' }}
        env:
          SERVER_LABEL: multi
        shell: bash
        run: |
          python tldw_Server_API/tests/scripts/server_lifecycle.py health-check

      - name: Run E2E tests (multi-user) - exclude Jobs
        env:
          AUTH_MODE: multi_user
        shell: bash
        run: |
          pytest -v -n 1 -m "multi_user and not jobs" --timeout=600 \
            tldw_Server_API/tests/e2e/test_multi_user_onboarding.py

      - name: Stop server (multi-user)
        if: always()
        env:
          SERVER_LABEL: multi
        shell: bash
        run: |
          if [ -f "tldw_Server_API/tests/scripts/server_lifecycle.py" ]; then
            python tldw_Server_API/tests/scripts/server_lifecycle.py stop || true
          else
            echo "server_lifecycle.py not found; skipping stop for '${SERVER_LABEL}'";
          fi

      - name: Print server log (multi-user)
        if: failure()
        env:
          SERVER_LABEL: multi
        shell: bash
        run: |
          python - <<'PY'
          import pathlib, os
          label = os.environ.get("SERVER_LABEL", "server")
          log_path = pathlib.Path(f"server-{label}.log")
          if log_path.exists():
              print("===== server log (multi-user) =====")
              print(log_path.read_text(encoding="utf-8"))
          PY
      - name: Upload server log (multi-user)
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: server-log-multi
          path: server-multi.log
