name: SBOM

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-sbom:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      # Populated in "Gather SBOM files" step
      SBOM_FILES: ""
      SBOM_COUNT: "0"
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8


      # No registry login required for public Docker Hub images used below
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Generate Python SBOM from pyproject (cdxgen)
        run: |
          if [ -f pyproject.toml ]; then \
            npx @appthreat/cdxgen -t python -o sbom-python.cdx.json; \
          fi

      - name: Generate SBOM (CycloneDX JSON)
        uses: anchore/sbom-action@8e94d75ddd33f69f691467e42275782e4bfefe84 # v0.20.9
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.cdx.json
          upload-artifact: true
          artifact-name: sbom-cyclonedx

      - name: Validate SBOM (CycloneDX CLI - pinned)
        id: validate_cli_pinned
        if: ${{ hashFiles('sbom.cdx.json') != '' }}
        continue-on-error: true
        uses: docker://cyclonedx/cyclonedx-cli:0.30.0
        with:
          args: >-
            validate --input-file sbom.cdx.json

      - name: Validate SBOM (CycloneDX CLI - pinned fallback)
        if: ${{ hashFiles('sbom.cdx.json') != '' && steps.validate_cli_pinned.outcome == 'failure' }}
        uses: docker://cyclonedx/cyclonedx-cli:0.29.1
        with:
          args: >-
            validate --input-file sbom.cdx.json
